databaseChangeLog:
  - changeSet:
      id: v1_2-create-breakage_audit-table
      author: Sergei Kraev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: breakage_audit
      changes:
        - createTable:
            tableName: breakage_audit
            columns:
              - column:
                  name: operation
                  type: char(1)
                  constraints:
                    nullable: false
                 #  primaryKey: true
               #  autoIncrement: true
              - column:
                  name: breakage
                  type: varchar(36)
                  constraints:
                    foreignKeyName: fk_breakage_audit_breakage_id
                    referencedTableName: breakage
                    referencedColumnNames: id
                    nullable: false
              - column:
                  name: department
                  type: varchar(36)
                  constraints:
                    foreignKeyName: fk_breakage_audit_department
                    referencedTableName: department
                    referencedColumnNames: id
                    nullable: false
              - column:
                  name: room
                  type: varchar(128)
                  constraints:
                    nullable: false
              - column:
                  name: breakage_topic
                  type: varchar(128)
                  constraints:
                    nullable: false
              - column:
                  name: breakage_text
                  type: varchar(2048)
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: breakage_status
                  constraints:
                    nullable: false
              - column:
                  name: priority
                  type: breakage_priority
                  constraints:
                    nullable: false
              - column:
                  name: executor
                  type: varchar(36)
                  constraints:
                    foreignKeyName: fk_breakage_audit_executor
                    referencedTableName: users
                    referencedColumnNames: id
              - column:
                  name: executor_appointed_by
                  type: varchar(36)
                  constraints:
                    foreignKeyName: fk_breakage_audit_executor_appointed_by
                    referencedTableName: users
                    referencedColumnNames: id
              - column:
                  name: deadline
                  type: timestamp
              - column:
                  name: last_updated_by
                  type: varchar(36)
                  constraints:
                    foreignKeyName: fk_breakage_audit_last_updated_by
                    referencedTableName: users
                    referencedColumnNames: id
                    nullable: false
              - column:
                  name: last_updated_date
                  type: timestamp
                  constraints:
                    nullable: false
        - addPrimaryKey:
          # catalogName: cat
            columnNames: breakage, last_updated_date, last_updated_by
            constraintName: pk_breakage_audit_id
          # forIndexName: A String
            schemaName: public
            tableName: breakage_audit
          # tablespace: A String
            validate: true

  - changeSet:
      id: v1_2-create-audit_breakage-function
      author: Sergei Kraev
      changes:
        - sql:  CREATE OR REPLACE FUNCTION audit_breakage() RETURNS trigger AS
                '
                BEGIN
                  IF TG_OP = ''INSERT'' THEN
                    INSERT INTO breakage_audit
                      SELECT ''I'', nt.id, nt.department, nt.room, nt.breakage_topic, nt.breakage_text, nt.status, nt.priority,
                        nt.executor, nt.executor_appointed_by, nt.deadline, nt.last_updated_by, nt.last_updated_date
                      FROM new_table AS nt;
                  ELSEIF TG_OP = ''UPDATE'' THEN
                    INSERT INTO breakage_audit
                      SELECT ''U'', nt.id, nt.department, nt.room, nt.breakage_topic, nt.breakage_text, nt.status, nt.priority,
                        nt.executor, nt.executor_appointed_by, nt.deadline, nt.last_updated_by, nt.last_updated_date
                      FROM new_table AS nt;
                  END IF;
                  RETURN NULL;
                END
                ' 
                LANGUAGE plpgsql;

  - changeSet:
      id: v1_2-create-audit_breakage_create-function
      author: Sergei Kraev
      changes:
        - sql:  CREATE TRIGGER audit_breakage_create AFTER INSERT ON breakage
                REFERENCING NEW TABLE AS new_table
                FOR EACH STATEMENT EXECUTE PROCEDURE audit_breakage();

  - changeSet:
      id: v1_2-create-audit_breakage_update-function
      author: Sergei Kraev
      changes:
        - sql:  CREATE TRIGGER audit_breakage_update AFTER UPDATE ON breakage
                REFERENCING NEW TABLE AS new_table
                FOR EACH STATEMENT EXECUTE PROCEDURE audit_breakage();